FROM postgres:16

# Switch to root for installing dependencies
USER root

RUN apt-get update && apt-get install -y \
    python3-psycopg2 procps \
    patroni \
	python3-etcd3 \
	python3-consul \
    && apt-get clean

RUN mkdir /var/lib/postgresql/config 
RUN chown postgres -R /var/lib/postgresql/
RUN chmod -R 700 /var/lib/postgresql/

# Revert to the default postgres user
USER postgres

# Expose PostgreSQL and Patroni API ports
EXPOSE 5432 8008

# Set the default command for Patroni
CMD ["patroni", "/etc/patroni/patroni.yml"]
